// script.js
let map = L.map('map').setView([25.276987, 51.520008], 13); // Fake Qatar location
let fakeMarker = L.marker([25.276987, 51.520008], { icon: L.icon({ iconUrl: 'assets/blue-marker.png', iconSize: [32, 32] }) }).addTo(map);

let currentLocationMarker;
let searchMarker;
let directionLayer;

L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=YOUR_MAPTILER_API_KEY', {
  attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a>',
  tileSize: 512,
  zoomOffset: -1
}).addTo(map);

// Remove marker on double click
fakeMarker.on('dblclick', () => map.removeLayer(fakeMarker));

// Toggle Panels
const hidePanel = (id) => document.getElementById(id).style.display = 'none';
document.getElementById('search-toggle').onclick = () => document.getElementById('search-panel').style.display = 'block';
document.getElementById('direction-toggle').onclick = () => document.getElementById('direction-panel').style.display = 'block';
document.getElementById('location-toggle').onclick = () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    if (currentLocationMarker) map.removeLayer(currentLocationMarker);
    currentLocationMarker = L.marker([latitude, longitude], {
      icon: L.icon({ iconUrl: 'assets/live-location.png', iconSize: [32, 32] })
    }).addTo(map);
    map.setView([latitude, longitude], 14);
  });
};

const searchControl = L.esri.Geocoding.geosearch({ placeholder: "Search..." }).addTo(map);
const results = L.layerGroup().addTo(map);
searchControl.on("results", function(data) {
  results.clearLayers();
  if (data.results.length > 0) {
    const { latlng } = data.results[0];
    if (searchMarker) map.removeLayer(searchMarker);
    searchMarker = L.marker(latlng, { icon: L.icon({ iconUrl: 'assets/red-marker.png', iconSize: [32, 32] }) }).addTo(map);
    map.setView(latlng, 14);
    if (fakeMarker) map.removeLayer(fakeMarker);
  }
});

// Direction
let control;
document.getElementById('getDirection').onclick = () => {
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  if (control) map.removeControl(control);
  control = L.Routing.control({
    waypoints: [],
    routeWhileDragging: false,
    show: false,
    createMarker: function(i, wp) {
      return L.marker(wp.latLng, {
        icon: L.icon({ iconUrl: i === 0 ? 'assets/live-location.png' : 'assets/red-marker.png', iconSize: [32, 32] })
      });
    }
  }).addTo(map);

  L.esri.Geocoding.geocode().text(start).run(function(err, resStart) {
    if (resStart.results.length > 0) {
      L.esri.Geocoding.geocode().text(end).run(function(err, resEnd) {
        if (resEnd.results.length > 0) {
          const startLatLng = resStart.results[0].latlng;
          const endLatLng = resEnd.results[0].latlng;
          control.setWaypoints([startLatLng, endLatLng]);
        }
      });
    }
  });
};
